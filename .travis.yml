dist: trusty
sudo: required
language: php

services:
- docker

php:
- '7.3'
- '7.4'
- 'nightly'

env:
  global:
  - DOCKER_COMPOSE_VERSION=1.27.4
  matrix:
  - DEPENDENCIES="low" TOOL="phpunit"
  - DEPENDENCIES="stable" TOOL="phpunit"
  - DEPENDENCIES="stable" TOOL="phpstan"
  - DEPENDENCIES="stable" TOOL="php-cs-fixer"
  - DEPENDENCIES="stable" INTEGRATION_TEST="enabled" CONFLUENT_VERSION="4.1.4"
  - DEPENDENCIES="stable" INTEGRATION_TEST="enabled" CONFLUENT_VERSION="5.5.2"
  - DEPENDENCIES="stable" INTEGRATION_TEST="enabled" CONFLUENT_VERSION="latest"

before_script:
- make install-phars
- if [ "$INTEGRATION_TEST" == "enabled" ]; then sudo rm -f /usr/local/bin/docker-compose; fi;
- if [ "$INTEGRATION_TEST" == "enabled" ]; then curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose; fi;
- if [ "$INTEGRATION_TEST" == "enabled" ]; then chmod +x docker-compose; fi;
- if [ "$INTEGRATION_TEST" == "enabled" ]; then sudo mv docker-compose /usr/local/bin; fi;
- if [ "$INTEGRATION_TEST" == "enabled" ]; then make platform; fi;
- composer self-update --2
- if [ "$DEPENDENCIES" == "stable" ]; then composer update --prefer-stable; fi;
- if [ "$DEPENDENCIES" == "low" ]; then composer update --prefer-lowest --prefer-stable; fi;

script:
- if [ "$INTEGRATION_TEST" == "enabled" ]; then COMPOSER=composer PHP=php make phpunit-integration ; else COMPOSER=composer PHP=php make ci-local; fi;

jobs:
  include:
  - stage: test
    env: DEPENDENCIES="low" TOOL="phpunit"
    script: COMPOSER=composer PHP=php make phpunit
  - env: DEPENDENCIES="stable" TOOL="phpunit"
    script: COMPOSER=composer PHP=php make phpunit
  - env: DEPENDENCIES="stable" TOOL="phpstan"
    script: COMPOSER=composer PHP=php make phpstan
  - env: DEPENDENCIES="stable" TOOL="php-cs-fixer"
    script: COMPOSER=composer PHP=php make cs-fixer
  - stage: integration
    php: '7.4'
    env: DEPENDENCIES="stable" INTEGRATION_TEST="enabled" CONFLUENT_VERSION="4.1.4"
  - env: DEPENDENCIES="stable" INTEGRATION_TEST="enabled" CONFLUENT_VERSION="5.5.2"
    php: '7.4'
  - env: DEPENDENCIES="stable" INTEGRATION_TEST="enabled" CONFLUENT_VERSION="latest"
    php: '7.4'
  - stage: coverage
    php: '7.3'
    env:
    - DEPENDENCIES="stable" TOOL="coverage"
    script:
    - PHP=php make coverage
  exclude:
  - php: 'nightly'
    env: DEPENDENCIES="stable" TOOL="php-cs-fixer"
  - stage: test
    env: DEPENDENCIES="stable" INTEGRATION_TEST="enabled" CONFLUENT_VERSION="4.1.4"
  - stage: test
    env: DEPENDENCIES="stable" INTEGRATION_TEST="enabled" CONFLUENT_VERSION="5.5.2"
  - stage: test
    env: DEPENDENCIES="stable" INTEGRATION_TEST="enabled" CONFLUENT_VERSION="latest"

after_script:
- make clean

branches:
  only:
  - master
  - '/^ft-.*/'
  - '/^v\d+\.\d+\.\d+$/'

cache:
  directories:
    - $HOME/.composer/cache/files
    - vendor
